<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>TelepathyQt4: call/video-widget.cpp</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="1">&nbsp;&nbsp;</td>
<td class="postheader" valign="center">
<a href="index.html">
<font color="#004faf">Home</font></a>&nbsp;&middot;
<a href="classes.html">
<font color="#004faf">All Classes</font></a>&nbsp;&middot;
<a href="namespaces.html">
<font color="#004faf">All Namespaces</font></a>&nbsp;&middot;
<a href="modules.html">
<font color="#004faf">Modules</font></a>&nbsp;&middot;
<a href="functions.html">
<font color="#004faf">Functions</font></a>&nbsp;&middot;
<a href="files.html">
<font color="#004faf">Files</font></a>
</td>
</tr>
</table>
</body>
</html>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="call_example_video_widget_cpp">call/video-widget.cpp </a></h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of TelepathyQt4</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright © 2009 Collabora Ltd. &lt;http://www.collabora.co.uk/&gt;</span>
<span class="comment"> * Copyright © 2009 Nokia Corporation</span>
<span class="comment"> *</span>
<span class="comment"> * This library is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> * License as published by the Free Software Foundation; either</span>
<span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> * Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> * License along with this library; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "video-widget.h"</span>
<span class="preprocessor">#include "_gen/video-widget.moc.hpp"</span>

<span class="preprocessor">#include &lt;QApplication&gt;</span>
<span class="preprocessor">#include &lt;QDebug&gt;</span>
<span class="preprocessor">#include &lt;QPainter&gt;</span>
<span class="preprocessor">#include &lt;QThread&gt;</span>

<span class="preprocessor">#include &lt;gst/interfaces/xoverlay.h&gt;</span>
<span class="preprocessor">#include &lt;gst/farsight/fs-element-added-notifier.h&gt;</span>

<span class="keyword">extern</span> <span class="keywordtype">void</span> qt_x11_set_global_double_buffer(<span class="keywordtype">bool</span>);

<span class="keyword">namespace </span>Tp {

<span class="keyword">struct </span>VideoWidget::Private {
    Private(VideoWidget *parent, GstBus *bus);
    ~Private();

    <span class="keyword">static</span> <span class="keywordtype">void</span> onElementAdded(FsElementAddedNotifier *notifier,
            GstBin *bin, GstElement *element,
            Private *<span class="keyword">self</span>);
    <span class="keyword">static</span> <span class="keywordtype">void</span> onSyncMessage(GstBus *bus, GstMessage *message,
            Private *<span class="keyword">self</span>);

    VideoWidget *parent;
    GstBus *bus;
    FsElementAddedNotifier *notifier;
    GstElement *sink;
    GstElement *overlay;
};

VideoWidget::Private::Private(VideoWidget *parent, GstBus *bus)
    : parent(parent),
      bus((GstBus *) gst_object_ref(bus)),
      overlay(0)
{
    notifier = fs_element_added_notifier_new();
    g_signal_connect(notifier, <span class="stringliteral">"element-added"</span>,
            G_CALLBACK(&amp;VideoWidget::Private::onElementAdded),
            <span class="keyword">this</span>);

    sink = gst_element_factory_make(<span class="stringliteral">"autovideosink"</span>, NULL);
    gst_object_ref(sink);
    gst_object_sink(sink);

    fs_element_added_notifier_add(notifier, GST_BIN(sink));
    gst_bus_enable_sync_message_emission(bus);

    g_signal_connect(bus, <span class="stringliteral">"sync-message"</span>,
            G_CALLBACK(&amp;VideoWidget::Private::onSyncMessage),
            <span class="keyword">this</span>);
}

VideoWidget::Private::~Private()
{
    g_object_unref(bus);
    g_object_unref(sink);
}

<span class="keywordtype">void</span> VideoWidget::Private::onElementAdded(FsElementAddedNotifier *notifier,
        GstBin *bin, GstElement *element, VideoWidget::Private *<span class="keyword">self</span>)
{
    <span class="keywordflow">if</span> (!self-&gt;overlay &amp;&amp; GST_IS_X_OVERLAY(element)) {
        <span class="keyword">self</span>-&gt;overlay = element;
        QMetaObject::invokeMethod(self-&gt;parent, <span class="stringliteral">"windowExposed"</span>, Qt::QueuedConnection);
    }

    <span class="keywordflow">if</span> (g_object_class_find_property(G_OBJECT_GET_CLASS(element),
                <span class="stringliteral">"force-aspect-ratio"</span>)) {
        g_object_set(G_OBJECT(element), <span class="stringliteral">"force-aspect-ratio"</span>, TRUE, NULL);
    }
}

<span class="keywordtype">void</span> VideoWidget::Private::onSyncMessage(GstBus *bus, GstMessage *message,
        VideoWidget::Private *<span class="keyword">self</span>)
{
    <span class="keywordflow">if</span> (GST_MESSAGE_TYPE(message) != GST_MESSAGE_ELEMENT) {
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span> (GST_MESSAGE_SRC(message) != (GstObject *) self-&gt;overlay) {
        <span class="keywordflow">return</span>;
    }

    <span class="keyword">const</span> GstStructure *s = gst_message_get_structure (message);

    <span class="keywordflow">if</span> (gst_structure_has_name(s, <span class="stringliteral">"prepare-xwindow-id"</span>) &amp;&amp; self-&gt;overlay) {
        QMetaObject::invokeMethod(self-&gt;parent, <span class="stringliteral">"setOverlay"</span>, Qt::QueuedConnection);
    }
}

VideoWidget::VideoWidget(GstBus *bus, QWidget *parent)
    : QWidget(parent),
      mPriv(new Private(this, bus))
{
    qt_x11_set_global_double_buffer(<span class="keyword">false</span>);

    QPalette palette;
    palette.setColor(QPalette::Background, Qt::black);
    setPalette(palette);
    setAutoFillBackground(<span class="keyword">true</span>);
}

VideoWidget::~VideoWidget()
{
    <span class="keyword">delete</span> mPriv;
}

GstElement *VideoWidget::element()<span class="keyword"> const</span>
<span class="keyword"></span>{
    <span class="keywordflow">return</span> mPriv-&gt;sink;
}

<span class="keywordtype">bool</span> VideoWidget::eventFilter(QEvent *ev)
{
    <span class="keywordflow">if</span> (ev-&gt;type() == QEvent::Show) {
        setAttribute(Qt::WA_NoSystemBackground, <span class="keyword">true</span>);
        setAttribute(Qt::WA_PaintOnScreen, <span class="keyword">true</span>);
        setOverlay();
    }
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
}

<span class="keywordtype">void</span> VideoWidget::setOverlay()
{
    <span class="keywordflow">if</span> (mPriv-&gt;overlay &amp;&amp; GST_IS_X_OVERLAY(mPriv-&gt;overlay)) {
        WId windowId = winId();
        QApplication::syncX();
        gst_x_overlay_set_xwindow_id(GST_X_OVERLAY(mPriv-&gt;overlay),
                windowId);
    }
    windowExposed();
}

<span class="keywordtype">void</span> VideoWidget::windowExposed()
{
    QApplication::syncX();
    <span class="keywordflow">if</span> (mPriv-&gt;overlay &amp;&amp; GST_IS_X_OVERLAY(mPriv-&gt;overlay)) {
        gst_x_overlay_expose(GST_X_OVERLAY(mPriv-&gt;overlay));
    }
}

} <span class="comment">// Tp</span>
</pre></div> </div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2009 Collabora Ltd. and Nokia Corporation</td>
<td width="30%" align="right"><div align="right">Telepathy-Qt4 0.1.10</div></td>
</tr></table></div></address>
</body>
</html>
