<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>TelepathyQt4: call/call-window.cpp</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="1">&nbsp;&nbsp;</td>
<td class="postheader" valign="center">
<a href="index.html">
<font color="#004faf">Home</font></a>&nbsp;&middot;
<a href="classes.html">
<font color="#004faf">All Classes</font></a>&nbsp;&middot;
<a href="namespaces.html">
<font color="#004faf">All Namespaces</font></a>&nbsp;&middot;
<a href="modules.html">
<font color="#004faf">Modules</font></a>&nbsp;&middot;
<a href="functions.html">
<font color="#004faf">Functions</font></a>&nbsp;&middot;
<a href="files.html">
<font color="#004faf">Files</font></a>
</td>
</tr>
</table>
</body>
</html>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="call_example_call_window_cpp">call/call-window.cpp </a></h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of TelepathyQt4</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright © 2009 Collabora Ltd. &lt;http://www.collabora.co.uk/&gt;</span>
<span class="comment"> * Copyright © 2009 Nokia Corporation</span>
<span class="comment"> *</span>
<span class="comment"> * This library is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> * License as published by the Free Software Foundation; either</span>
<span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> * Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> * License along with this library; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "call-window.h"</span>
<span class="preprocessor">#include "_gen/call-window.moc.hpp"</span>

<span class="preprocessor">#include "call-handler.h"</span>
<span class="preprocessor">#include "call-roster-widget.h"</span>

<span class="preprocessor">#include &lt;TelepathyQt4/Types&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/Connection&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/ConnectionManager&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingConnection&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingOperation&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingReady&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/StreamedMediaChannel&gt;</span>

<span class="preprocessor">#include &lt;QDebug&gt;</span>

<span class="keyword">using namespace </span>Tp;

CallWindow::CallWindow(<span class="keyword">const</span> QString &amp;username, <span class="keyword">const</span> QString &amp;password,
        QWidget *parent)
    : QMainWindow(parent),
      mUsername(username),
      mPassword(password)
{
    setWindowTitle(<span class="stringliteral">"Call"</span>);

    mCM = <a class="code" href="classTp_1_1ConnectionManager.html#5bc49afe0b6cc1be3c729ba7c391594f">ConnectionManager::create</a>(<span class="stringliteral">"gabble"</span>);
    connect(mCM-&gt;becomeReady(),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onCMReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));

    mCallHandler = <span class="keyword">new</span> CallHandler(<span class="keyword">this</span>);

    setupGui();

    resize(240, 320);
}

CallWindow::~CallWindow()
{
    <span class="keywordflow">if</span> (mConn) {
        mConn-&gt;requestDisconnect();
    }
}

<span class="keywordtype">void</span> CallWindow::setupGui()
{
    mRoster = <span class="keyword">new</span> CallRosterWidget(mCallHandler);
    setCentralWidget(mRoster);
}

<span class="keywordtype">void</span> CallWindow::onCMReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CM cannot become ready"</span>;
        <span class="keywordflow">return</span>;
    }

    qDebug() &lt;&lt; <span class="stringliteral">"CM ready"</span>;
    QVariantMap params;
    params.insert(<span class="stringliteral">"account"</span>, QVariant(mUsername));
    params.insert(<span class="stringliteral">"password"</span>, QVariant(mPassword));
    PendingConnection *pconn = mCM-&gt;requestConnection(<span class="stringliteral">"jabber"</span>, params);
    connect(pconn,
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onConnectionCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));
}

<span class="keywordtype">void</span> CallWindow::onConnectionCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"Unable to create connection"</span>;
        <span class="keywordflow">return</span>;
    }

    qDebug() &lt;&lt; <span class="stringliteral">"Connection created"</span>;
    PendingConnection *pconn =
        qobject_cast&lt;PendingConnection *&gt;(op);
    <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> conn = pconn-&gt;connection();
    mConn = conn;
    connect(conn-&gt;requestConnect(<a class="code" href="classTp_1_1Connection.html#d462b38ef9d8587725758053e4e72c20">Connection::FeatureSelfContact</a>),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onConnectionConnected(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));
    connect(conn.data(),
            SIGNAL(invalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)),
            SLOT(onConnectionInvalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)));
}

<span class="keywordtype">void</span> CallWindow::onConnectionConnected(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"Connection cannot become connected"</span>;
        <span class="keywordflow">return</span>;
    }

    PendingReady *pr = qobject_cast&lt;PendingReady *&gt;(op);
    <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> conn = <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a>(qobject_cast&lt;Connection *&gt;(pr-&gt;object()));

    <span class="keywordflow">if</span> (conn-&gt;interfaces().contains(<a class="code" href="group__ifacestrconsts.html#g5ccffebd43067e758dcce504e917e5a0">TELEPATHY_INTERFACE_CONNECTION_INTERFACE_CAPABILITIES</a>)) {
        <a class="code" href="structTp_1_1CapabilityPair.html">Tp::CapabilityPair</a> capability = {
            <a class="code" href="group__ifacestrconsts.html#g747a1c27e9afa1ec9019fd9cbd547033">TELEPATHY_INTERFACE_CHANNEL_TYPE_STREAMED_MEDIA</a>,
            <a class="code" href="group__flagtypeconsts.html#gg67ae7566328cc6d7b1fba71c37c9e488167661789de680ef657354d6176bfa14">Tp::ChannelMediaCapabilityAudio</a> |
            <a class="code" href="group__flagtypeconsts.html#gg67ae7566328cc6d7b1fba71c37c9e488094b63722a53ebb844a24fcb1a8c7a53">Tp::ChannelMediaCapabilityVideo</a> |
                <a class="code" href="group__flagtypeconsts.html#gg67ae7566328cc6d7b1fba71c37c9e488622aa3835ebb0f101681ee82a78cc91a">Tp::ChannelMediaCapabilityNATTraversalSTUN</a> |
                <a class="code" href="group__flagtypeconsts.html#gg67ae7566328cc6d7b1fba71c37c9e4884c46c8b7fa9716b678bbc739f19f5a08">Tp::ChannelMediaCapabilityNATTraversalGTalkP2P</a>
        };
        qDebug() &lt;&lt; <span class="stringliteral">"CallWindow::onConnectionConnected: advertising capabilities"</span>;
        conn-&gt;capabilitiesInterface()-&gt;AdvertiseCapabilities(
                <a class="code" href="group__list.html#g3a797de86503f1f503b6bdf201658428">Tp::CapabilityPairList</a>() &lt;&lt; capability,
                QStringList());
    }

    <span class="keywordflow">if</span> (conn-&gt;interfaces().contains(<a class="code" href="group__ifacestrconsts.html#gd0fcbfbd4452cde92a8de17e92971212">TELEPATHY_INTERFACE_CONNECTION_INTERFACE_REQUESTS</a>)) {
        qDebug() &lt;&lt; <span class="stringliteral">"CallWindow::onConnectionConnected: connecting to Connection.Interface.NewChannels"</span>;
        connect(conn-&gt;requestsInterface(),
                SIGNAL(NewChannels(<span class="keyword">const</span> <a class="code" href="group__list.html#g75775051e01274f75ceeb330b4647e3a">Tp::ChannelDetailsList</a>&amp;)),
                SLOT(onNewChannels(<span class="keyword">const</span> <a class="code" href="group__list.html#g75775051e01274f75ceeb330b4647e3a">Tp::ChannelDetailsList</a>&amp;)));
    }

    mRoster-&gt;addConnection(conn);
}

<span class="keywordtype">void</span> CallWindow::onConnectionInvalidated(DBusProxy *proxy,
        <span class="keyword">const</span> QString &amp;errorName, <span class="keyword">const</span> QString &amp;errorMessage)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWindow::onConnectionInvalidated: connection became invalid:"</span> &lt;&lt;
        errorName &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; errorMessage;
    mRoster-&gt;removeConnection(mConn);
    mConn.reset();
}

<span class="keywordtype">void</span> CallWindow::onNewChannels(<span class="keyword">const</span> <a class="code" href="group__list.html#g75775051e01274f75ceeb330b4647e3a">Tp::ChannelDetailsList</a> &amp;channels)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWindow::onNewChannels"</span>;
    <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="structTp_1_1ChannelDetails.html">Tp::ChannelDetails</a> &amp;details, channels) {
        QString channelType = details.<a class="code" href="structTp_1_1ChannelDetails.html#be2c104656672cd16ffbfd5d46ffb990">properties</a>.value(QLatin1String(<a class="code" href="group__ifacestrconsts.html#gc6c58c723e76c7c493a043476441ec2f">TELEPATHY_INTERFACE_CHANNEL</a> <span class="stringliteral">".ChannelType"</span>)).toString();
        <span class="keywordtype">bool</span> requested = details.<a class="code" href="structTp_1_1ChannelDetails.html#be2c104656672cd16ffbfd5d46ffb990">properties</a>.value(QLatin1String(<a class="code" href="group__ifacestrconsts.html#gc6c58c723e76c7c493a043476441ec2f">TELEPATHY_INTERFACE_CHANNEL</a> <span class="stringliteral">".Requested"</span>)).toBool();
        qDebug() &lt;&lt; <span class="stringliteral">" channelType:"</span> &lt;&lt; channelType;
        qDebug() &lt;&lt; <span class="stringliteral">" requested  :"</span> &lt;&lt; requested;

        <span class="keywordflow">if</span> (channelType == <a class="code" href="group__ifacestrconsts.html#g747a1c27e9afa1ec9019fd9cbd547033">TELEPATHY_INTERFACE_CHANNEL_TYPE_STREAMED_MEDIA</a> &amp;&amp;
            !requested) {
            <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> channel = <a class="code" href="classTp_1_1StreamedMediaChannel.html#c649743b81121f7a3e0468cc4c154029">StreamedMediaChannel::create</a>(mConn,
                        details.<a class="code" href="structTp_1_1ChannelDetails.html#d66ee284094a65b5b3249637c1690892">channel</a>.path(),
                        details.<a class="code" href="structTp_1_1ChannelDetails.html#be2c104656672cd16ffbfd5d46ffb990">properties</a>);
            mCallHandler-&gt;addIncomingCall(channel);
        }
    }
}
</pre></div> </div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2009 Collabora Ltd. and Nokia Corporation</td>
<td width="30%" align="right"><div align="right">Telepathy-Qt4 0.1.10</div></td>
</tr></table></div></address>
</body>
</html>
