<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>TelepathyQt4: call/call-widget.cpp</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="1">&nbsp;&nbsp;</td>
<td class="postheader" valign="center">
<a href="index.html">
<font color="#004faf">Home</font></a>&nbsp;&middot;
<a href="classes.html">
<font color="#004faf">All Classes</font></a>&nbsp;&middot;
<a href="namespaces.html">
<font color="#004faf">All Namespaces</font></a>&nbsp;&middot;
<a href="modules.html">
<font color="#004faf">Modules</font></a>&nbsp;&middot;
<a href="functions.html">
<font color="#004faf">Functions</font></a>&nbsp;&middot;
<a href="files.html">
<font color="#004faf">Files</font></a>
</td>
</tr>
</table>
</body>
</html>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="call_example_call_widget_cpp">call/call-widget.cpp </a></h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of TelepathyQt4</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright © 2009 Collabora Ltd. &lt;http://www.collabora.co.uk/&gt;</span>
<span class="comment"> * Copyright © 2009 Nokia Corporation</span>
<span class="comment"> *</span>
<span class="comment"> * This library is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> * License as published by the Free Software Foundation; either</span>
<span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> * Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> * License along with this library; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "call-widget.h"</span>
<span class="preprocessor">#include "_gen/call-widget.moc.hpp"</span>

<span class="preprocessor">#include "video-widget.h"</span>

<span class="preprocessor">#include &lt;TelepathyQt4/Channel&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/Connection&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/Contact&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/ContactManager&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingChannel&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingReady&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/StreamedMediaChannel&gt;</span>

<span class="preprocessor">#include &lt;QDebug&gt;</span>
<span class="preprocessor">#include &lt;QHBoxLayout&gt;</span>
<span class="preprocessor">#include &lt;QLabel&gt;</span>
<span class="preprocessor">#include &lt;QPushButton&gt;</span>
<span class="preprocessor">#include &lt;QStatusBar&gt;</span>
<span class="preprocessor">#include &lt;QVBoxLayout&gt;</span>

<span class="keyword">using namespace </span>Tp;

CallWidget::CallWidget(<span class="keyword">const</span> StreamedMediaChannelPtr &amp;chan,
        <span class="keyword">const</span> ContactPtr &amp;contact,
        QWidget *parent)
    : QWidget(parent),
      mChan(chan),
      mContact(contact),
      mTfChan(new FarsightChannel(chan, this)),
      mPmsAudio(0),
      mPmsVideo(0)
{
    setWindowTitle(QString(<span class="stringliteral">"Call (%1)"</span>).arg(mContact-&gt;id()));

    setAttribute(Qt::WA_DeleteOnClose);

    setupGui();

    connect(mChan-&gt;becomeReady(<a class="code" href="classTp_1_1StreamedMediaChannel.html#09498f4cf8010881d6ef540865074f36">StreamedMediaChannel::FeatureStreams</a>),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
            SLOT(onChannelReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
    connect(mChan.data(),
            SIGNAL(invalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)),
            SLOT(onChannelInvalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)));

    connect(mTfChan,
            SIGNAL(statusChanged(Tp::FarsightChannel::Status)),
            SLOT(onTfChannelStatusChanged(Tp::FarsightChannel::Status)));
}

CallWidget::~CallWidget()
{
    <span class="keywordflow">if</span> (mChan) {
        mChan-&gt;requestClose();
    }
}

<span class="keywordtype">void</span> CallWidget::setupGui()
{
    QVBoxLayout *mainBox = <span class="keyword">new</span> QVBoxLayout;

    <span class="comment">// buttons</span>
    QHBoxLayout *btnBox = <span class="keyword">new</span> QHBoxLayout;

    mBtnHangup = <span class="keyword">new</span> QPushButton(<span class="stringliteral">"Hangup"</span>);
    connect(mBtnHangup,
            SIGNAL(clicked(<span class="keywordtype">bool</span>)),
            SLOT(onBtnHangupClicked()));
    btnBox-&gt;addWidget(mBtnHangup);

    mBtnSendAudio = <span class="keyword">new</span> QPushButton(<span class="stringliteral">"Send Audio"</span>);
    mBtnSendAudio-&gt;setCheckable(<span class="keyword">true</span>);
    mBtnSendAudio-&gt;setChecked(<span class="keyword">true</span>);
    mBtnSendAudio-&gt;setEnabled(<span class="keyword">false</span>);
    connect(mBtnSendAudio,
            SIGNAL(toggled(<span class="keywordtype">bool</span>)),
            SLOT(onBtnSendAudioToggled(<span class="keywordtype">bool</span>)));
    btnBox-&gt;addWidget(mBtnSendAudio);

    mBtnSendVideo = <span class="keyword">new</span> QPushButton(<span class="stringliteral">"Send Video"</span>);
    mBtnSendVideo-&gt;setCheckable(<span class="keyword">true</span>);
    mBtnSendVideo-&gt;setChecked(<span class="keyword">false</span>);
    mBtnSendVideo-&gt;setEnabled(<span class="keyword">false</span>);
    connect(mBtnSendVideo,
            SIGNAL(toggled(<span class="keywordtype">bool</span>)),
            SLOT(onBtnSendVideoToggled(<span class="keywordtype">bool</span>)));
    btnBox-&gt;addWidget(mBtnSendVideo);

    mainBox-&gt;addLayout(btnBox);

    <span class="comment">// video</span>
    QHBoxLayout *videoBox = <span class="keyword">new</span> QHBoxLayout;

    VideoWidget *videoWidget = mTfChan-&gt;videoWidget();
    videoWidget-&gt;setMinimumSize(320, 240);
    videoBox-&gt;addWidget(videoWidget);

    QVBoxLayout *previewBox = <span class="keyword">new</span> QVBoxLayout;

    VideoWidget *videoPreview = mTfChan-&gt;videoPreview();
    videoPreview-&gt;setFixedSize(160, 120);
    previewBox-&gt;addWidget(videoPreview);

    previewBox-&gt;addStretch(1);

    videoBox-&gt;addLayout(previewBox);

    mainBox-&gt;addLayout(videoBox);

    <span class="comment">// stream status</span>
    QFrame *frame = <span class="keyword">new</span> QFrame;
    frame-&gt;setFrameStyle(QFrame::Box | QFrame::Sunken);

    QVBoxLayout *streamBox = <span class="keyword">new</span> QVBoxLayout;

    QLabel *lbl = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"&lt;b&gt;Streams&lt;/b&gt;"</span>));
    streamBox-&gt;addWidget(lbl);
    streamBox-&gt;addSpacing(4);

    lbl = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"&lt;b&gt;Audio&lt;/b&gt;"</span>));
    streamBox-&gt;addWidget(lbl);
    mLblAudioDirection = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"Direction: None"</span>));
    streamBox-&gt;addWidget(mLblAudioDirection);
    mLblAudioState = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"State: Disconnected"</span>));
    streamBox-&gt;addWidget(mLblAudioState);
    streamBox-&gt;addSpacing(4);

    lbl = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"&lt;b&gt;Video&lt;/b&gt;"</span>));
    streamBox-&gt;addWidget(lbl);
    mLblVideoDirection = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"Direction: None"</span>));
    streamBox-&gt;addWidget(mLblVideoDirection);
    mLblVideoState = <span class="keyword">new</span> QLabel(QLatin1String(<span class="stringliteral">"State: Disconnected"</span>));
    streamBox-&gt;addWidget(mLblVideoState);

    streamBox-&gt;addStretch(1);
    frame-&gt;setLayout(streamBox);

    videoBox-&gt;addSpacing(4);
    frame-&gt;setLayout(streamBox);
    videoBox-&gt;addWidget(frame);

    <span class="comment">// status bar</span>
    mStatusBar = <span class="keyword">new</span> QStatusBar;
    mainBox-&gt;addWidget(mStatusBar);

    setLayout(mainBox);
}

<span class="keywordtype">void</span> CallWidget::onChannelReady(PendingOperation *op)
{
    <span class="keywordflow">if</span> (op-&gt;isError()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CallWidget::onChannelReady: channel cannot become ready:"</span> &lt;&lt;
            op-&gt;errorName() &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; op-&gt;errorMessage();
        mChan-&gt;requestClose();
        callEnded(QLatin1String(<span class="stringliteral">"Unable to establish call"</span>));
        <span class="keywordflow">return</span>;
    }

    connect(mChan.data(),
            SIGNAL(streamAdded(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;)),
            SLOT(onStreamAdded(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;)));
    connect(mChan.data(),
            SIGNAL(streamRemoved(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;)),
            SLOT(onStreamRemoved(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;)));
    connect(mChan.data(),
            SIGNAL(streamDirectionChanged(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;,
                                          <a class="code" href="group__enumtypeconsts.html#g11b032acc11b5b4ae81e41ac7f8fddde">Tp::MediaStreamDirection</a>,
                                          <a class="code" href="group__flagtypeconsts.html#g6a722bba1d00123e71ccab05486e9b66">Tp::MediaStreamPendingSend</a>)),
            SLOT(onStreamDirectionChanged(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;,
                                          <a class="code" href="group__enumtypeconsts.html#g11b032acc11b5b4ae81e41ac7f8fddde">Tp::MediaStreamDirection</a>,
                                          <a class="code" href="group__flagtypeconsts.html#g6a722bba1d00123e71ccab05486e9b66">Tp::MediaStreamPendingSend</a>)));
    connect(mChan.data(),
            SIGNAL(streamStateChanged(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;,
                                      <a class="code" href="group__enumtypeconsts.html#g0190fa6d2691cdf0b90825f4b89dc758">Tp::MediaStreamState</a>)),
            SLOT(onStreamStateChanged(<span class="keyword">const</span> <a class="code" href="classTp_1_1SharedPtr.html">Tp::MediaStreamPtr</a> &amp;,
                                      <a class="code" href="group__enumtypeconsts.html#g0190fa6d2691cdf0b90825f4b89dc758">Tp::MediaStreamState</a>)));

    <a class="code" href="namespaceTp.html#9d80f814b9969f36477f728ea51d90b3">MediaStreams</a> streams = mChan-&gt;streams();
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onChannelReady: number of streams:"</span> &lt;&lt; streams.size();
    <span class="keywordflow">if</span> (streams.size() &gt; 0) {
        <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream, streams) {
            qDebug() &lt;&lt; <span class="stringliteral">"  type:"</span> &lt;&lt;
                (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"Audio"</span> : <span class="stringliteral">"Video"</span>);
            qDebug() &lt;&lt; <span class="stringliteral">"  direction:"</span> &lt;&lt; stream-&gt;direction();
            qDebug() &lt;&lt; <span class="stringliteral">"  state:"</span> &lt;&lt; stream-&gt;state();

            onStreamDirectionChanged(stream, stream-&gt;direction(),
                    stream-&gt;pendingSend());
            onStreamStateChanged(stream, stream-&gt;state());
        }
    }

    mBtnSendAudio-&gt;setEnabled(<span class="keyword">true</span>);
    mBtnSendVideo-&gt;setEnabled(<span class="keyword">true</span>);

    onBtnSendAudioToggled(mBtnSendAudio-&gt;isChecked());
}

<span class="keywordtype">void</span> CallWidget::onChannelInvalidated(DBusProxy *proxy,
        <span class="keyword">const</span> QString &amp;errorName, <span class="keyword">const</span> QString &amp;errorMessage)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onChannelInvalidated: channel became invalid:"</span> &lt;&lt;
        errorName &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; errorMessage;
    callEnded(errorMessage);
}

<span class="keywordtype">void</span> CallWidget::onStreamCreated(PendingOperation *op)
{
    <span class="keywordflow">if</span> (op == mPmsAudio) {
        mPmsAudio = 0;
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op == mPmsVideo) {
        mPmsVideo = 0;
    }

    <span class="keywordflow">if</span> (op-&gt;isError()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CallWidget::onStreamCreated: unable to create stream:"</span> &lt;&lt;
            op-&gt;errorName() &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; op-&gt;errorMessage();

        QPushButton *btn = 0;

        <span class="comment">// we cannot create the stream for some reason, update buttons</span>
        <span class="keywordflow">if</span> (!streamForType(<a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>)) {
            btn = mBtnSendAudio;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!streamForType(<a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>)) {
            btn = mBtnSendVideo;
        } <span class="keywordflow">else</span> {
            Q_ASSERT(<span class="keyword">false</span>);
        }

        btn-&gt;blockSignals(<span class="keyword">true</span>);
        btn-&gt;setChecked(<span class="keyword">false</span>);
        btn-&gt;blockSignals(<span class="keyword">false</span>);

        <a class="code" href="namespaceTp.html#9d80f814b9969f36477f728ea51d90b3">MediaStreams</a> streams = mChan-&gt;streams();
        <span class="keywordflow">if</span> (streams.size() == 0) {
            callEnded(op-&gt;errorMessage());
        }
        <span class="keywordflow">return</span>;
    }

    <span class="comment">// do nothing as streamAdded signal will be emitted</span>
}

<span class="keywordtype">void</span> CallWidget::onStreamAdded(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onStreamAdded:"</span> &lt;&lt;
        (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"Audio"</span> : <span class="stringliteral">"Video"</span>) &lt;&lt;
        <span class="stringliteral">"stream created"</span>;
    qDebug() &lt;&lt; <span class="stringliteral">" direction:"</span> &lt;&lt; stream-&gt;direction();
    qDebug() &lt;&lt; <span class="stringliteral">" state:"</span> &lt;&lt; stream-&gt;state();

    updateStreamDirection(stream);
    onStreamDirectionChanged(stream, stream-&gt;direction(),
            stream-&gt;pendingSend());
    onStreamStateChanged(stream, stream-&gt;state());
}

<span class="keywordtype">void</span> CallWidget::onStreamRemoved(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onStreamRemoved:"</span> &lt;&lt;
        (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"Audio"</span> : <span class="stringliteral">"Video"</span>) &lt;&lt;
        <span class="stringliteral">"stream removed"</span>;
    <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>) {
        mBtnSendAudio-&gt;blockSignals(<span class="keyword">true</span>);
        mBtnSendAudio-&gt;setChecked(<span class="keyword">false</span>);
        mBtnSendAudio-&gt;blockSignals(<span class="keyword">false</span>);
        mLblAudioDirection-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: None"</span>));
        mLblAudioState-&gt;setText(QLatin1String(<span class="stringliteral">"State: Disconnected"</span>));
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>) {
        mBtnSendVideo-&gt;blockSignals(<span class="keyword">true</span>);
        mBtnSendVideo-&gt;setChecked(<span class="keyword">false</span>);
        mBtnSendVideo-&gt;blockSignals(<span class="keyword">false</span>);
        mLblVideoDirection-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: None"</span>));
        mLblVideoState-&gt;setText(QLatin1String(<span class="stringliteral">"State: Disconnected"</span>));
    }
}

<span class="keywordtype">void</span> CallWidget::onStreamDirectionChanged(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream,
        <a class="code" href="group__enumtypeconsts.html#g11b032acc11b5b4ae81e41ac7f8fddde">Tp::MediaStreamDirection</a> direction,
        <a class="code" href="group__flagtypeconsts.html#g6a722bba1d00123e71ccab05486e9b66">Tp::MediaStreamPendingSend</a> pendingSend)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onStreamDirectionChanged:"</span> &lt;&lt;
        (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"Audio"</span> : <span class="stringliteral">"Video"</span>) &lt;&lt;
        <span class="stringliteral">"stream direction changed to"</span> &lt;&lt; direction;

    QLabel *lbl = 0;
    QPushButton *btn = 0;
    <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>) {
        lbl = mLblAudioDirection;
        btn = mBtnSendAudio;
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>) {
        lbl = mLblVideoDirection;
        btn = mBtnSendVideo;
    } <span class="keywordflow">else</span> {
        Q_ASSERT(<span class="keyword">false</span>);
    }

    <span class="keywordflow">if</span> (direction == <a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde1b21a39ec9aaffa53efb333cdbe045e5">Tp::MediaStreamDirectionSend</a>) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: Sending"</span>));
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction == <a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde8610d3a0ef5e2ed59644b8398a1cd2d4">Tp::MediaStreamDirectionReceive</a>) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: Receiving"</span>));
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction == (<a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde1b21a39ec9aaffa53efb333cdbe045e5">Tp::MediaStreamDirectionSend</a> | <a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde8610d3a0ef5e2ed59644b8398a1cd2d4">Tp::MediaStreamDirectionReceive</a>)) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: Sending/Receiving"</span>));
    } <span class="keywordflow">else</span> {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"Direction: None"</span>));
    }

    btn-&gt;blockSignals(<span class="keyword">true</span>);
    btn-&gt;setChecked(direction &amp; <a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde1b21a39ec9aaffa53efb333cdbe045e5">Tp::MediaStreamDirectionSend</a>);
    btn-&gt;blockSignals(<span class="keyword">false</span>);
}

<span class="keywordtype">void</span> CallWidget::onStreamStateChanged(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream,
        <a class="code" href="group__enumtypeconsts.html#g0190fa6d2691cdf0b90825f4b89dc758">Tp::MediaStreamState</a> state)
{
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onStreamStateChanged:"</span> &lt;&lt;
        (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"Audio"</span> : <span class="stringliteral">"Video"</span>) &lt;&lt;
        <span class="stringliteral">"stream state changed to"</span> &lt;&lt; state;

    QLabel *lbl = 0;
    <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>) {
        lbl = mLblAudioState;
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>) {
        lbl = mLblVideoState;
    } <span class="keywordflow">else</span> {
        Q_ASSERT(<span class="keyword">false</span>);
    }
    <span class="keywordflow">if</span> (state == <a class="code" href="namespaceTp.html#g0190fa6d2691cdf0b90825f4b89dc758e3759b00e8d43793fd0f032d4387f8ed">Tp::MediaStreamStateDisconnected</a>) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"State: Disconnected"</span>));
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="namespaceTp.html#g0190fa6d2691cdf0b90825f4b89dc75872df99b749e070c54812932aa7faae9a">Tp::MediaStreamStateConnecting</a>) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"State: Connecting"</span>));
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="namespaceTp.html#g0190fa6d2691cdf0b90825f4b89dc7587b6af7e6e0da2dadbd0deeb2d43bba64">Tp::MediaStreamStateConnected</a>) {
        lbl-&gt;setText(QLatin1String(<span class="stringliteral">"State: Connected"</span>));
    }
}

<span class="keywordtype">void</span> CallWidget::onTfChannelStatusChanged(FarsightChannel::Status status)
{
    <span class="keywordflow">switch</span> (status) {
    <span class="keywordflow">case</span> FarsightChannel::StatusConnecting:
        mStatusBar-&gt;showMessage(<span class="stringliteral">"Connecting..."</span>);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> FarsightChannel::StatusConnected:
        mStatusBar-&gt;showMessage(<span class="stringliteral">"Connected"</span>);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> FarsightChannel::StatusDisconnected:
        mChan-&gt;requestClose();
        callEnded(<span class="stringliteral">"Call terminated"</span>);
        <span class="keywordflow">break</span>;
    }
}

<span class="keywordtype">void</span> CallWidget::onBtnHangupClicked()
{
    mChan-&gt;requestClose();
    callEnded(<span class="stringliteral">"Call terminated"</span>);
}

<span class="keywordtype">void</span> CallWidget::onBtnSendAudioToggled(<span class="keywordtype">bool</span> checked)
{
    <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> stream =
        streamForType(<a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>);
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onBtnSendAudioToggled: checked:"</span> &lt;&lt; checked;
    <span class="keywordflow">if</span> (!stream) {
        <span class="keywordflow">if</span> (mPmsAudio) {
            <span class="keywordflow">return</span>;
        }
        qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onBtnSendAudioToggled: creating audio stream"</span>;
        mPmsAudio = mChan-&gt;requestStream(mContact, <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>);
        connect(mPmsAudio,
                SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
                SLOT(onStreamCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
    } <span class="keywordflow">else</span> {
        updateStreamDirection(stream);
    }
}

<span class="keywordtype">void</span> CallWidget::onBtnSendVideoToggled(<span class="keywordtype">bool</span> checked)
{
    <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> stream =
        streamForType(<a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>);
    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onBtnSendVideoToggled: checked:"</span> &lt;&lt; checked;
    <span class="keywordflow">if</span> (!stream) {
        <span class="keywordflow">if</span> (mPmsVideo) {
            <span class="keywordflow">return</span>;
        }
        qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::onBtnSendVideoToggled: creating video stream"</span>;
        mPmsVideo = mChan-&gt;requestStream(mContact, <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>);
        connect(mPmsVideo,
                SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
                SLOT(onStreamCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
    } <span class="keywordflow">else</span> {
        updateStreamDirection(stream);
    }
}

<a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> CallWidget::streamForType(<a class="code" href="group__enumtypeconsts.html#g42cf0ab18a3ef224160ab103cffcf082">Tp::MediaStreamType</a> type)<span class="keyword"> const</span>
<span class="keyword"></span>{
    <a class="code" href="namespaceTp.html#9d80f814b9969f36477f728ea51d90b3">MediaStreams</a> streams = mChan-&gt;streams();
    <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream, streams) {
        <span class="keywordflow">if</span> (stream-&gt;type() == type) {
            <span class="keywordflow">return</span> stream;
        }
    }
    <span class="keywordflow">return</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a>();
}

<span class="keywordtype">void</span> CallWidget::updateStreamDirection(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#d62890aa8a0b78d7828ae7a7c940faf4">MediaStreamPtr</a> &amp;stream)
{
    <span class="keywordtype">bool</span> checked = <span class="keyword">false</span>;
    <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a>) {
        checked = mBtnSendAudio-&gt;isChecked();
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082068ed05351ceb8b664b289d0b33d6a8b">Tp::MediaStreamTypeVideo</a>) {
        checked = mBtnSendVideo-&gt;isChecked();
    } <span class="keywordflow">else</span> {
        Q_ASSERT(<span class="keyword">false</span>);
    }

    qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::updateStreamDirection: updating"</span> &lt;&lt;
        (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"audio"</span> : <span class="stringliteral">"video"</span>) &lt;&lt;
        <span class="stringliteral">"stream direction"</span>;

    <span class="keywordflow">if</span> (checked) {
        <span class="keywordflow">if</span> (!(stream-&gt;direction() &amp; Tp::MediaStreamDirectionSend)) {
            <span class="keywordtype">int</span> dir = stream-&gt;direction() | Tp::MediaStreamDirectionSend;
            stream-&gt;requestDirection((<a class="code" href="group__enumtypeconsts.html#g11b032acc11b5b4ae81e41ac7f8fddde">Tp::MediaStreamDirection</a>) dir);
            qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::updateStreamDirection: start sending"</span> &lt;&lt;
                (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"audio"</span> : <span class="stringliteral">"video"</span>);
        } <span class="keywordflow">else</span> {
            qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::updateStreamDirection:"</span> &lt;&lt;
                (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"audio"</span> : <span class="stringliteral">"video"</span>) &lt;&lt;
                <span class="stringliteral">"stream updated"</span>;
        }
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (stream-&gt;direction() &amp; Tp::MediaStreamDirectionSend) {
            <span class="keywordtype">int</span> dir = stream-&gt;direction() &amp; ~Tp<a class="code" href="namespaceTp.html#g11b032acc11b5b4ae81e41ac7f8fddde1b21a39ec9aaffa53efb333cdbe045e5">::MediaStreamDirectionSend</a>;
            qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::updateStreamDirection: stop sending "</span> &lt;&lt;
                (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"audio"</span> : <span class="stringliteral">"video"</span>);
            stream-&gt;requestDirection((<a class="code" href="group__enumtypeconsts.html#g11b032acc11b5b4ae81e41ac7f8fddde">Tp::MediaStreamDirection</a>) dir);
        } <span class="keywordflow">else</span> {
            qDebug() &lt;&lt; <span class="stringliteral">"CallWidget::updateStreamDirection:"</span> &lt;&lt;
                (stream-&gt;type() == <a class="code" href="namespaceTp.html#g42cf0ab18a3ef224160ab103cffcf082d58dbb6eb193f601d466005ace0cdfba">Tp::MediaStreamTypeAudio</a> ? <span class="stringliteral">"audio"</span> : <span class="stringliteral">"video"</span>) &lt;&lt;
                <span class="stringliteral">"stream updated"</span>;
        }
    }
}

<span class="keywordtype">void</span> CallWidget::callEnded(<span class="keyword">const</span> QString &amp;message)
{
    mStatusBar-&gt;showMessage(message);
    disconnect(mChan.data(),
               SIGNAL(invalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)),
               <span class="keyword">this</span>,
               SLOT(onChannelInvalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)));
    disconnect(mTfChan,
               SIGNAL(statusChanged(Tp::FarsightChannel::Status)),
               <span class="keyword">this</span>,
               SLOT(onTfChannelStatusChanged(Tp::FarsightChannel::Status)));
    setEnabled(<span class="keyword">false</span>);
}
</pre></div> </div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2009 Collabora Ltd. and Nokia Corporation</td>
<td width="30%" align="right"><div align="right">Telepathy-Qt4 0.1.10</div></td>
</tr></table></div></address>
</body>
</html>
