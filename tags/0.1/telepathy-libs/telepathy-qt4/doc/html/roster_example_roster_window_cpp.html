<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>TelepathyQt4: roster/roster-window.cpp</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="1">&nbsp;&nbsp;</td>
<td class="postheader" valign="center">
<a href="index.html">
<font color="#004faf">Home</font></a>&nbsp;&middot;
<a href="classes.html">
<font color="#004faf">All Classes</font></a>&nbsp;&middot;
<a href="namespaces.html">
<font color="#004faf">All Namespaces</font></a>&nbsp;&middot;
<a href="modules.html">
<font color="#004faf">Modules</font></a>&nbsp;&middot;
<a href="functions.html">
<font color="#004faf">Functions</font></a>&nbsp;&middot;
<a href="files.html">
<font color="#004faf">Files</font></a>
</td>
</tr>
</table>
</body>
</html>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="roster_example_roster_window_cpp">roster/roster-window.cpp </a></h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of TelepathyQt4</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright (C) 2009 Collabora Ltd. &lt;http://www.collabora.co.uk/&gt;</span>
<span class="comment"> *</span>
<span class="comment"> * This library is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> * License as published by the Free Software Foundation; either</span>
<span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> * Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> * License along with this library; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "roster-window.h"</span>
<span class="preprocessor">#include "_gen/roster-window.moc.hpp"</span>

<span class="preprocessor">#include "roster-widget.h"</span>

<span class="preprocessor">#include &lt;TelepathyQt4/Types&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/ConnectionManager&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingConnection&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingOperation&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingReady&gt;</span>

<span class="preprocessor">#include &lt;QDebug&gt;</span>

<span class="keyword">using namespace </span>Tp;

RosterWindow::RosterWindow(<span class="keyword">const</span> QString &amp;username, <span class="keyword">const</span> QString &amp;password,
        QWidget *parent)
    : QMainWindow(parent),
      mUsername(username),
      mPassword(password)
{
    setWindowTitle(<span class="stringliteral">"Roster"</span>);

    setupGui();

    mCM = <a class="code" href="classTp_1_1ConnectionManager.html#5bc49afe0b6cc1be3c729ba7c391594f">ConnectionManager::create</a>(<span class="stringliteral">"gabble"</span>);
    connect(mCM-&gt;becomeReady(),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onCMReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));

    resize(240, 320);
}

RosterWindow::~RosterWindow()
{
    <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> &amp;conn, mConns) {
        conn-&gt;requestDisconnect();
    }
}

<span class="keywordtype">void</span> RosterWindow::setupGui()
{
    mRoster = <span class="keyword">new</span> RosterWidget();
    setCentralWidget(mRoster);
}

<span class="keywordtype">void</span> RosterWindow::onCMReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CM cannot become ready"</span>;
        <span class="keywordflow">return</span>;
    }

    qDebug() &lt;&lt; <span class="stringliteral">"CM ready"</span>;
    QVariantMap params;
    params.insert(<span class="stringliteral">"account"</span>, QVariant(mUsername));
    params.insert(<span class="stringliteral">"password"</span>, QVariant(mPassword));
    PendingConnection *pconn = mCM-&gt;requestConnection(<span class="stringliteral">"jabber"</span>, params);
    connect(pconn,
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onConnectionCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));
}

<span class="keywordtype">void</span> RosterWindow::onConnectionCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"Unable to create connection"</span>;
        <span class="keywordflow">return</span>;
    }

    qDebug() &lt;&lt; <span class="stringliteral">"Connection created"</span>;
    PendingConnection *pconn =
        qobject_cast&lt;PendingConnection *&gt;(op);
    <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> conn = pconn-&gt;connection();
    mConns.append(conn);
    connect(conn-&gt;requestConnect(),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)),
            SLOT(onConnectionConnected(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *)));
    connect(conn.data(),
            SIGNAL(invalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)),
            SLOT(onConnectionInvalidated(<a class="code" href="classTp_1_1DBusProxy.html">Tp::DBusProxy</a> *, <span class="keyword">const</span> QString &amp;, <span class="keyword">const</span> QString &amp;)));
}

<span class="keywordtype">void</span> RosterWindow::onConnectionConnected(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a> *op)
{
    <span class="keywordflow">if</span> (op-&gt;<a class="code" href="classTp_1_1PendingOperation.html#32759931a1b2d6380407c6a18abd46e3">isError</a>()) {
        qWarning() &lt;&lt; <span class="stringliteral">"Connection cannot become connected"</span>;
        <span class="keywordflow">return</span>;
    }

    PendingReady *pr = qobject_cast&lt;PendingReady *&gt;(op);
    <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> conn = <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a>(qobject_cast&lt;Connection *&gt;(pr-&gt;object()));
    mRoster-&gt;addConnection(conn);
}

<span class="keywordtype">void</span> RosterWindow::onConnectionInvalidated(DBusProxy *proxy,
        <span class="keyword">const</span> QString &amp;errorName, <span class="keyword">const</span> QString &amp;errorMessage)
{
    qDebug() &lt;&lt; <span class="stringliteral">"RosterWindow::onConnectionInvalidated: connection became invalid:"</span> &lt;&lt;
        errorName &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; errorMessage;
    <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> &amp;conn, mConns) {
        <span class="keywordflow">if</span> (conn.data() == proxy) {
            mRoster-&gt;removeConnection(conn);
            mConns.removeOne(conn);
        }
    }
}
</pre></div> </div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2009 Collabora Ltd. and Nokia Corporation</td>
<td width="30%" align="right"><div align="right">Telepathy-Qt4 0.1.10</div></td>
</tr></table></div></address>
</body>
</html>
