<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>TelepathyQt4: call/call-handler.cpp</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td width="1">&nbsp;&nbsp;</td>
<td class="postheader" valign="center">
<a href="index.html">
<font color="#004faf">Home</font></a>&nbsp;&middot;
<a href="classes.html">
<font color="#004faf">All Classes</font></a>&nbsp;&middot;
<a href="namespaces.html">
<font color="#004faf">All Namespaces</font></a>&nbsp;&middot;
<a href="modules.html">
<font color="#004faf">Modules</font></a>&nbsp;&middot;
<a href="functions.html">
<font color="#004faf">Functions</font></a>&nbsp;&middot;
<a href="files.html">
<font color="#004faf">Files</font></a>
</td>
</tr>
</table>
</body>
</html>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="call_example_call_handler_cpp">call/call-handler.cpp </a></h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of TelepathyQt4</span>
<span class="comment"> *</span>
<span class="comment"> * Copyright © 2009 Collabora Ltd. &lt;http://www.collabora.co.uk/&gt;</span>
<span class="comment"> * Copyright © 2009 Nokia Corporation</span>
<span class="comment"> *</span>
<span class="comment"> * This library is free software; you can redistribute it and/or</span>
<span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> * License as published by the Free Software Foundation; either</span>
<span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> * This library is distributed in the hope that it will be useful,</span>
<span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> * Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> * License along with this library; if not, write to the Free Software</span>
<span class="comment"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "call-handler.h"</span>
<span class="preprocessor">#include "_gen/call-handler.moc.hpp"</span>

<span class="preprocessor">#include "call-widget.h"</span>

<span class="preprocessor">#include &lt;TelepathyQt4/Channel&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/Connection&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/Contact&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/ContactManager&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingChannel&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/PendingReady&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/ReferencedHandles&gt;</span>
<span class="preprocessor">#include &lt;TelepathyQt4/StreamedMediaChannel&gt;</span>

<span class="preprocessor">#include &lt;QDebug&gt;</span>
<span class="preprocessor">#include &lt;QMessageBox&gt;</span>

<span class="keyword">using namespace </span>Tp;

CallHandler::CallHandler(QObject *parent)
    : QObject(parent)
{
}

CallHandler::~CallHandler()
{
    <span class="keywordflow">foreach</span> (CallWidget *call, mCalls) {
        call-&gt;close();
    }
}

<span class="keywordtype">void</span> CallHandler::addOutgoingCall(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#58b74925faeec84ce5da45dbf41bebd4">ContactPtr</a> &amp;contact)
{
    QVariantMap request;
    request.insert(QLatin1String(<a class="code" href="group__ifacestrconsts.html#gc6c58c723e76c7c493a043476441ec2f">TELEPATHY_INTERFACE_CHANNEL</a> <span class="stringliteral">".ChannelType"</span>),
                   <a class="code" href="group__ifacestrconsts.html#g747a1c27e9afa1ec9019fd9cbd547033">TELEPATHY_INTERFACE_CHANNEL_TYPE_STREAMED_MEDIA</a>);
    request.insert(QLatin1String(<a class="code" href="group__ifacestrconsts.html#gc6c58c723e76c7c493a043476441ec2f">TELEPATHY_INTERFACE_CHANNEL</a> <span class="stringliteral">".TargetHandleType"</span>),
                   <a class="code" href="namespaceTp.html#g126a76c59a74d758b3d0cdc357315fac4cf6259ea0d8a7eeb2576425ca6b4cbe">HandleTypeContact</a>);
    request.insert(QLatin1String(<a class="code" href="group__ifacestrconsts.html#gc6c58c723e76c7c493a043476441ec2f">TELEPATHY_INTERFACE_CHANNEL</a> <span class="stringliteral">".TargetHandle"</span>),
                   contact-&gt;handle()[0]);

    <a class="code" href="namespaceTp.html#4152eed7c9d171dbdddaa4bd8e92b046">ConnectionPtr</a> conn = contact-&gt;manager()-&gt;connection();
    connect(conn-&gt;ensureChannel(request),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
            SLOT(onOutgoingChannelCreated(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
}

<span class="keywordtype">void</span> CallHandler::addIncomingCall(<span class="keyword">const</span> <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> &amp;chan)
{
    mChannels.append(chan);
    connect(chan-&gt;becomeReady(),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
            SLOT(onIncomingChannelReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
}

<span class="keywordtype">void</span> CallHandler::onOutgoingChannelCreated(PendingOperation *op)
{
    <span class="keywordflow">if</span> (op-&gt;isError()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CallHandler::onOutgoingChannelCreated: channel cannot be created:"</span> &lt;&lt;
            op-&gt;errorName() &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; op-&gt;errorMessage();

        QMessageBox msgBox;
        msgBox.setText(QString(<span class="stringliteral">"Unable to call (%1)"</span>).arg(op-&gt;errorMessage()));
        msgBox.exec();
        <span class="keywordflow">return</span>;
    }

    PendingChannel *pc = qobject_cast&lt;PendingChannel *&gt;(op);

    <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> chan = <a class="code" href="classTp_1_1StreamedMediaChannel.html#c649743b81121f7a3e0468cc4c154029">StreamedMediaChannel::create</a>(pc-&gt;connection(),
            pc-&gt;objectPath(), pc-&gt;immutableProperties());
    mChannels.append(chan);
    connect(chan-&gt;becomeReady(),
            SIGNAL(finished(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)),
            SLOT(onOutgoingChannelReady(<a class="code" href="classTp_1_1PendingOperation.html">Tp::PendingOperation</a>*)));
}

<span class="keywordtype">void</span> CallHandler::onOutgoingChannelReady(PendingOperation *op)
{
    PendingReady *pr = qobject_cast&lt;PendingReady *&gt;(op);
    <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> chan = <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a>(qobject_cast&lt;StreamedMediaChannel *&gt;(pr-&gt;object()));

    <span class="keywordflow">if</span> (op-&gt;isError()) {
        qWarning() &lt;&lt; <span class="stringliteral">"CallHandler::onOutgoingChannelReady: channel cannot become ready:"</span> &lt;&lt;
            op-&gt;errorName() &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; op-&gt;errorMessage();

        mChannels.removeOne(chan);

        QMessageBox msgBox;
        msgBox.setText(QString(<span class="stringliteral">"Unable to call (%1)"</span>).arg(op-&gt;errorMessage()));
        msgBox.exec();
        <span class="keywordflow">return</span>;
    }

    ContactManager *cm = chan-&gt;connection()-&gt;contactManager();
    <a class="code" href="namespaceTp.html#58b74925faeec84ce5da45dbf41bebd4">ContactPtr</a> contact = cm-&gt;lookupContactByHandle(chan-&gt;targetHandle());
    Q_ASSERT(contact);

    CallWidget *call = <span class="keyword">new</span> CallWidget(chan, contact);
    mCalls.append(call);
    connect(call,
            SIGNAL(destroyed(QObject *)),
            SLOT(onCallTerminated(QObject *)));
    call-&gt;show();
}

<span class="keywordtype">void</span> CallHandler::onIncomingChannelReady(PendingOperation *op)
{
    PendingReady *pr = qobject_cast&lt;PendingReady *&gt;(op);
    <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> chan = <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a>(qobject_cast&lt;StreamedMediaChannel *&gt;(pr-&gt;object()));

    <span class="keywordflow">if</span> (op-&gt;isError()) {
        <span class="comment">// ignore - channel cannot be ready</span>
        qWarning() &lt;&lt; <span class="stringliteral">"CallHandler::onIncomingChannelReady: channel cannot become ready:"</span> &lt;&lt;
            op-&gt;errorName() &lt;&lt; <span class="stringliteral">"-"</span> &lt;&lt; op-&gt;errorMessage();

        mChannels.removeOne(chan);
        <span class="keywordflow">return</span>;
    }

    <a class="code" href="namespaceTp.html#58b74925faeec84ce5da45dbf41bebd4">ContactPtr</a> contact = chan-&gt;initiatorContact();

    QMessageBox msgBox;
    msgBox.setText(<span class="stringliteral">"Incoming call"</span>);
    msgBox.setInformativeText(QString(<span class="stringliteral">"%1 is calling you, do you want to answer?"</span>).arg(contact-&gt;id()));
    msgBox.setStandardButtons(QMessageBox::Yes | QMessageBox::No);
    msgBox.setDefaultButton(QMessageBox::Yes);
    <span class="keywordtype">int</span> ret = msgBox.exec();

    <span class="keywordflow">if</span> (ret == QMessageBox::No) {
        chan-&gt;requestClose();
        <span class="keywordflow">return</span>;
    }

    chan-&gt;acceptCall();

    CallWidget *call = <span class="keyword">new</span> CallWidget(chan, contact);
    mCalls.append(call);
    connect(call,
            SIGNAL(destroyed(QObject *)),
            SLOT(onCallTerminated(QObject *)));
    call-&gt;show();
}

<span class="keywordtype">void</span> CallHandler::onCallTerminated(QObject *obj)
{
    CallWidget *call = (CallWidget *) obj;
    <a class="code" href="namespaceTp.html#83d08c6451ff6b5d59b4e39f690dc813">StreamedMediaChannelPtr</a> chan = call-&gt;channel();
    mCalls.removeOne(call);
    mChannels.removeOne(chan);
}
</pre></div> </div>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2009 Collabora Ltd. and Nokia Corporation</td>
<td width="30%" align="right"><div align="right">Telepathy-Qt4 0.1.10</div></td>
</tr></table></div></address>
</body>
</html>
